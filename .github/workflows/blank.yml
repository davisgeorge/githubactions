name: CI cd
on:
  workflow_dispatch:
    # inputs:
    #   branch:
    #     description: 'The branch to build'
    #     required: true
    #   environment:
    #     description: 'The environment to deploy to'
    #     required: true
      


  # push:
  #   branches:
  #     - main
  #     - release
  #     - test
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout 
        uses: actions/checkout@v3
        with:
          repository: davisgeorge/githubactions
          ref: ${{github.ref}}
          # ref: ${{ github.event.inputs.branch }}
          
            
    
        
      - name: Run a multi-line script
        run: |
            git fetch --tags
            tagFmt="^v?[0-9]+\.[0-9]+\.[0-9]+$"
            tag="$(git for-each-ref --sort=-v:refname --format '%(refname:lstrip=2)' | grep -E "$tagFmt" | head -n 1)"
            [[ "$tag" =~ ^([0-9]+) ]] # use ^(v[0-9]+) for vX
            major=${BASH_REMATCH[1]}
            # update major tag
            git tag -f "$major"
            git push -f origin "$major"
            # add vX as 1 is linked to short sha bug https://github.com/anothrNick/github-tag-action/actions/runs/3139501775/jobs/5099976842#step:1:35
            git tag -f "v$major"
            git push -f origin "v$major"

          # echo "$GITHUB_ACTOR"
          # git config user.name "$GITHUB_ACTOR"
          # git config user.email "github-actions@users.noreply.github.com"
          # git tag -a V2 -m"test tag"
          # git push origin --tags
        #   VERSION_PREFIX="v"

        #   VERSION_MAJOR_MINOR="1.0"

        #   VERSION_PATCH=$(git tag --list
        #   "${VERSION_PREFIX}${VERSION_MAJOR_MINOR}" --sort=-version:refname |
        #   head -n 1 | grep -oE '[0-9]+$')

        #   if [ -z "$VERSION_PATCH" ]; then
        #     VERSION_PATCH=0
        #   else
        #     VERSION_PATCH=$((VERSION_PATCH + 1))
        #   fi

        #   NEW_TAG="${VERSION_PREFIX}${VERSION_MAJOR_MINOR}.${VERSION_PATCH}"

        #   echo "Generated new tag: $NEW_TAG"

        #   echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
  dev-relase:
    name: Deploy-Dev
    if: '${{ github.ref == ''refs/heads/release'' }}'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: release
      - name: this is dev branch
        run: |
          echo "this is dev-relase branch"
          git branch
  dev-test:
    name: Deploy-test
    if: '${{ github.ref == ''refs/heads/test'' }}'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: release
      - name: this is dev branch
        run: |
          echo "this is dev-test branch"
          git branch
